# GitLab CI/CD Pipeline for DACSANTAYBAC
# Build production code and mirror to GitHub

stages:
  - build
  - deploy

variables:
  GIT_STRATEGY: clone

# Build stage - Process and minify code
build_production:
  stage: build
  image: node:18-alpine
  before_script:
    - apk add --no-cache git
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@gitlab.com"
  script:
    - echo "Creating production directory..."
    - mkdir -p production
    - cp -r * production/ || true
    - cd production
    - echo "Removing development files from production..."
    - rm -f .gitlab-ci.yml
    - rm -f test-ci-local.ps1
    - rm -f gitlab-token-setup.html
    - rm -f GITLAB_AUTH_FIX.md
    - rm -f GITLAB_CI_SETUP.md
    - rm -f SIMPLE_WORKFLOW.md
    - rm -rf production
    - rm -rf .git
    - echo "Creating production .gitignore..."
    - |
      cat > .gitignore << 'EOF'
      # Production deployment - clean build
      node_modules/
      *.log
      .env
      .DS_Store
      Thumbs.db
      production/
      test-ci-local.ps1
      gitlab-token-setup.html
      GITLAB_AUTH_FIX.md
      GITLAB_CI_SETUP.md
      SIMPLE_WORKFLOW.md
      EOF
    - echo "Processing JavaScript files..."
    - |
      if [ -f "js/script.js" ]; then
        echo "Minifying script.js..."
        sed 's|//.*||g; s|/\*.*\*/||g; s/[[:space:]]\+/ /g' js/script.js > js/script.min.js
        ADMIN_B64=$(echo -n "admin" | base64)
        PASS_B64=$(echo -n "admin123" | base64)
        sed -i "s/\"admin\"/atob('$ADMIN_B64')/g" js/script.min.js
        sed -i "s/\"admin123\"/atob('$PASS_B64')/g" js/script.min.js
        echo "âœ… script.min.js created with obfuscated credentials"
      fi
    - |
      if [ -f "js/admin.js" ]; then
        echo "Minifying admin.js..."
        sed 's|//.*||g; s|/\*.*\*/||g; s/[[:space:]]\+/ /g' js/admin.js > js/admin.min.js
        ADMIN_B64=$(echo -n "admin" | base64)
        PASS_B64=$(echo -n "admin123" | base64)
        sed -i "s/\"admin\"/atob('$ADMIN_B64')/g" js/admin.min.js
        sed -i "s/\"admin123\"/atob('$PASS_B64')/g" js/admin.min.js
        echo "âœ… admin.min.js created with obfuscated credentials"
      fi
    - echo "Updating HTML files to use minified versions..."
    - |
      if [ -f "index.html" ]; then
        sed -i 's|js/script\.js|js/script.min.js|g' index.html
        echo "âœ… index.html updated to use minified JS"
      fi
    - |
      if [ -f "admin.html" ]; then
        sed -i 's|js/script\.js|js/script.min.js|g' admin.html
        sed -i 's|js/admin\.js|js/admin.min.js|g' admin.html
        echo "âœ… admin.html updated to use minified JS"
      fi
    - echo "Creating deployment info..."
    - |
      cat > DEPLOYMENT_INFO.txt << EOF
      ðŸš€ DACSANTAYBAC - Production Deployment
      =====================================
      
      ðŸ“… Build Date: $(date)
      ðŸ”§ Built by: GitLab CI/CD
      ðŸ“¦ Build ID: $CI_PIPELINE_ID
      ðŸŒ¿ Source Branch: $CI_COMMIT_REF_NAME
      ðŸ“ Commit: $CI_COMMIT_SHORT_SHA
      
      ðŸ”’ Security Features:
      - Admin credentials obfuscated with Base64
      - Development files removed
      - Source code minified
      - Clean production build
      
      ðŸŒ Live Website: https://nguyenngocbinh.github.io/DACSANTAYBAC/
      ðŸ‘¨â€ðŸ’¼ Admin Panel: https://nguyenngocbinh.github.io/DACSANTAYBAC/admin.html
      
      Repository Strategy:
      ðŸ“š GitLab (Private): Full source code with comments
      ðŸŒ GitHub (Public): Minified production code
      EOF
    - echo "âœ… Production build completed"
    - ls -la
  artifacts:
    paths:
      - production/
    expire_in: 1 hour
  only:
    - main

# Deploy stage - Push production build to GitHub
deploy_to_github:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_production
  before_script:
    - apk add --no-cache git
  script:
    - git config --global user.email "nguyenngocbinhneu@gmail.com"
    - git config --global user.name "Nguyen Ngoc Binh"
    - echo "Initializing production repository..."
    - cd production
    - git init
    - git add .
    - git commit -m "ðŸš€ Production deployment from GitLab CI - Pipeline #$CI_PIPELINE_ID"
    - echo "Adding GitHub remote..."
    - git remote add github https://$GITHUB_TOKEN@github.com/nguyenngocbinh/DACSANTAYBAC.git
    - echo "Pushing production build to GitHub..."
    - |
      git push github main --force || (
        echo "Push failed";
        exit 1
      )
    - echo "âœ… Successfully deployed production build to GitHub!"
    - echo "ðŸŒ Website: https://nguyenngocbinh.github.io/DACSANTAYBAC/"
    - echo "ðŸ‘¨â€ðŸ’¼ Admin Panel: https://nguyenngocbinh.github.io/DACSANTAYBAC/admin.html"
  only:
    - main

# Mirror stage - Full repository mirror (source backup)
mirror_to_github:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - git config --global user.email "nguyenngocbinhneu@gmail.com"
    - git config --global user.name "Nguyen Ngoc Binh"
    - echo "Creating full repository mirror..."
    - git clone --mirror https://oauth2:$GITLAB_PERSONAL_ACCESS_TOKEN@gitlab.com/nguyenngocbinh/DACSANTAYBAC.git || (echo "Mirror clone failed"; exit 1)
    - cd DACSANTAYBAC.git
    - echo "Adding GitHub mirror remote..."
    - git remote add github-mirror https://$GITHUB_TOKEN@github.com/nguyenngocbinh/DACSANTAYBAC-SOURCE.git
    - echo "Pushing full mirror to GitHub..."
    - git push --mirror github-mirror || echo "Mirror push failed (repository may not exist)"
    - echo "âœ… Repository mirror completed (if target exists)"
  when: manual
  only:
    - main

# Manual deployment job
manual_deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_production
  before_script:
    - apk add --no-cache git
  script:
    - git config --global user.email "nguyenngocbinhneu@gmail.com"
    - git config --global user.name "Nguyen Ngoc Binh"
    - echo "Manual deployment starting..."
    - cd production
    - git init
    - git add .
    - git commit -m "ðŸ”§ Manual production deployment - Pipeline #$CI_PIPELINE_ID"
    - git remote add github https://$GITHUB_TOKEN@github.com/nguyenngocbinh/DACSANTAYBAC.git
    - git push github main --force
    - echo "âœ… Manual deployment completed!"
    - echo "ðŸŒ Website: https://nguyenngocbinh.github.io/DACSANTAYBAC/"
    - echo "ðŸ‘¨â€ðŸ’¼ Admin Panel: https://nguyenngocbinh.github.io/DACSANTAYBAC/admin.html"
  when: manual
  only:
    - main
